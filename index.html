<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business English LMS</title>
    <!-- Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Muat Ikon Lucide (FIX: Tambahkan 'defer') -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Muat TinyMCE (Rich Text Editor) (FIX: Tambahkan 'defer') -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.3/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        /* Style kustom untuk LMS */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styling untuk h3, p, ul, table, dll. di dalam 
           #worksheet-reading-content sekarang ditangani 
           secara otomatis oleh class 'prose' dari plugin 
           typography Tailwind. Style manual dihapus.
        */
    </style>
</head>

<body class="bg-gray-100 font-sans">

    <!-- 1. Halaman Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900 px-4">
        <div class="w-full max-w-md p-8 bg-white rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">LMS Login</h2>
            <p class="text-center text-gray-500 mb-6">Business English</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="mahasiswa.a@gmail.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="••••••••">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    Login
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <!-- 2. Halaman Aplikasi Utama (Dashboard) -->
    <div id="app-screen" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i data-lucide="book-open" class="h-6 w-6 text-blue-600"></i>
                        <span class="ml-2 text-xl font-semibold text-gray-800">Business English LMS</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-sm text-gray-600"></span>
                        <button id="logout-btn"
                            class="text-sm font-medium text-gray-700 hover:text-blue-600 flex items-center">
                            <i data-lucide="log-out" class="h-4 w-4 mr-1"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Konten Utama -->
        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col md:flex-row gap-6">

                <!-- Sidebar (Daftar Materi) -->
                <nav class="w-full md:w-1/3 lg:w-1/4 bg-white p-5 rounded-xl shadow-lg h-fit">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Daftar Materi</h3>
                    <div id="material-list-loading" class="text-gray-500">Memuat materi...</div>
                    <ul id="material-list" class="space-y-2">
                        <!-- Materi akan di-render di sini oleh JS -->
                    </ul>
                    <button id="add-material-btn"
                        class="hidden w-full mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center justify-center space-x-2">
                        <i data-lucide="plus" class="h-4 w-4"></i>
                        <span>Tambah Materi Baru</span>
                    </button>
                </nav>

                <!-- Area Konten Detail -->
                <div class="w-full md:w-2/3 lg:w-3/4">
                    <!-- Pesan Selamat Datang -->
                    <div id="welcome-message"
                        class="bg-white p-8 rounded-xl shadow-lg flex flex-col items-center justify-center h-full">
                        <i data-lucide="inbox" class="h-16 w-16 text-blue-300 mb-4"></i>
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Selamat Datang!</h2>
                        <p class="text-gray-500 text-center">Silakan pilih materi dari daftar di sebelah kiri untuk
                            memulai.</p>
                    </div>

                    <!-- Tampilan Detail Materi -->
                    <div id="material-detail" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
                        <!-- Header Detail Materi -->
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center gap-3">
                                <h2 id="material-title" class="text-2xl font-bold text-gray-900">Judul Materi</h2>
                                <!-- Tombol Edit Judul (khusus dosen) -->
                                <button id="edit-title-icon-btn" class="hidden text-gray-500 hover:text-blue-600 transition">
                                    <i data-lucide="pencil" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Navigasi Tab -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                                <button id="tab-worksheet" onclick="showTab('worksheet')"
                                    class="tab-btn py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-500">
                                    Lembar Kerja
                                </button>
                                <button id="tab-edit" onclick="showTab('edit')"
                                    class="tab-btn hidden py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                    Edit Worksheet
                                </button>
                                <button id="tab-submissions" onclick="showTab('submissions')"
                                    class="tab-btn hidden py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                    Rekap Nilai
                                </button>
                            </nav>
                        </div>

                        <!-- Konten Tab -->
                        <div class="p-6">
                            <!-- Tab: Lembar Kerja (Mahasiswa & Dosen) -->
                            <div id="worksheet-content">
                                <div id="worksheet-loading" class="text-center text-gray-500">Memuat...</div>
                                <div id="worksheet-empty" class="hidden text-center text-gray-500">
                                    Dosen belum menambahkan materi atau soal untuk pertemuan ini.
                                </div>
                                <!-- Konten Link eBook -->
                                <div id="ebook-link-container" class="hidden mb-6">
                                    <a id="ebook-link-btn" href="#" target="_blank" rel="noopener noreferrer"
                                        class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                        <i data-lucide="book"></i>
                                        Buka Materi eBook
                                    </a>
                                </div>
                                <!-- Konten Materi Bacaan (dari HTML atau JSON lama) -->
                                <div id="worksheet-reading-content" class="prose max-w-none mb-8">
                                    <!-- Materi bacaan akan di-render di sini -->
                                </div>
                                <!-- Konten Form Kuis -->
                                <div id="worksheet-form-container" class="hidden">
                                    <!-- Soal akan di-render di sini -->
                                </div>
                                <button id="submit-worksheet-btn"
                                    class="hidden mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                    Simpan Jawaban
                                </button>
                            </div>

                            <!-- Tab: Edit Worksheet (Dosen) - DIPERBARUI -->
                            <div id="edit-content" class="hidden">
                                
                                <!-- 1. Editor Materi Bacaan (Rich Text) -->
                                <div>
                                    <label for="reading-content-editor" class="block text-sm font-medium text-gray-700 mb-2">
                                        Materi Bacaan (Rich Text Editor):
                                    </label>
                                    <textarea id="reading-content-editor"></textarea>
                                </div>

                                <!-- 2. Link eBook -->
                                <div class="mt-6">
                                    <label for="ebook-url-input" class="block text-sm font-medium text-gray-700 mb-2">
                                        Link eBook/Materi Tambahan (Opsional):
                                    </label>
                                    <input type="url" id="ebook-url-input"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://drive.google.com/file/d/...">
                                </div>
                                
                                <!-- 3. Editor Kuis (JSON) -->
                                <div class="mt-6">
                                    <label for="quiz-json-input"
                                        class="block text-sm font-medium text-gray-700 mb-2">
                                        Tempel (Paste) JSON **Kuis** di Sini:
                                    </label>
                                    <textarea id="quiz-json-input" rows="15"
                                        class="w-full p-4 border border-gray-300 rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder='{ "questions": [ ... ] }'></textarea>
                                </div>

                                <!-- 4. Tombol Simpan -->
                                <div class="flex gap-4 mt-6">
                                    <button id="save-worksheet-btn"
                                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                        Simpan Semua Perubahan
                                    </button>
                                </div>

                                <!-- 5. Contoh JSON (Hanya Kuis) -->
                                <div class="mt-6 p-4 bg-gray-50 rounded-lg border">
                                    <h4 class="font-semibold mb-2">Contoh Format JSON Kuis:</h4>
                                    <pre
                                        class="text-xs text-gray-600 overflow-auto"><code>{
  "questions": [
    {
      "question_type": "multiple_choice",
      "question_text": "Teks pertanyaan?",
      "options": ["Opsi A", "Opsi B", "Opsi C"],
      "correct_answer": 2
    },
    {
      "question_type": "true_false",
      "question_text": "Ini benar?",
      "correct_answer": true
    },
    {
      "type": "fill_in_the_blank",
      "question": "A person who buys goods is a ____.",
      "answer": "customer"
    }
  ]
}</code></pre>
                                </div>
                            </div>

                            <!-- Tab: Rekap Nilai (Dosen) -->
                            <div id="submissions-content" class="hidden">
                                <div id="submissions-loading" class="text-center text-gray-500">Memuat rekap nilai...
                                </div>
                                <div id="submissions-empty" class="hidden text-center text-gray-500">
                                    Belum ada mahasiswa yang mengerjakan.
                                </div>
                                <div id="submissions-list" class="space-y-4">
                                    <!-- Rekap akan di-render di sini -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notifikasi/Pesan Toast -->
    <div id="toast-message"
        class="hidden fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white shadow-lg transition-all duration-300">
        <span id="toast-text"></span>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            setLogLevel,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            onSnapshot,
            query,
            writeBatch,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuxnDKTGfelPzVtmUgk0txMOiV8Z-fG8A",
            authDomain: "business-english-34e6b.firebaseapp.com",
            projectId: "business-english-34e6b",
            storageBucket: "business-english-34e6b.firebasestorage.app",
            messagingSenderId: "790922726030",
            appId: "1:790922726030:web:b65d9a57024e303f1817df",
            measurementId: "G-6C7K6LKWP8"
        };

        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Tampilkan log debug Firestore

        // --- Path Koleksi ---
        const materialsColPath = "materials";
        const submissionsColPath = "submissions";

        // --- Variabel Global & State ---
        let currentUser = null;
        let userRole = null; // 'mahasiswa' atau 'dosen'
        let currentEditingMaterialId = null;
        let isTinymceInitialized = false; // Flag untuk TinyMCE

        // Cache lokal untuk data
        const materialsCache = new Map();
        const submissionsCache = new Map();

        // Unsubscribe listeners (untuk cleanup)
        let materialsListener = null;
        let submissionsListener = null;

        // --- Elemen UI ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const userInfo = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');

        const materialList = document.getElementById('material-list');
        const materialListLoading = document.getElementById('material-list-loading');
        const addMaterialBtn = document.getElementById('add-material-btn');

        const welcomeMessage = document.getElementById('welcome-message');
        const materialDetail = document.getElementById('material-detail');
        const materialTitle = document.getElementById('material-title');
        const editTitleIconBtn = document.getElementById('edit-title-icon-btn'); 

        const tabEdit = document.getElementById('tab-edit');
        const tabSubmissions = document.getElementById('tab-submissions');

        const worksheetContent = document.getElementById('worksheet-content');
        const worksheetLoading = document.getElementById('worksheet-loading');
        const worksheetEmpty = document.getElementById('worksheet-empty');
        const worksheetFormContainer = document.getElementById('worksheet-form-container');
        const worksheetReadingContent = document.getElementById('worksheet-reading-content');
        const submitWorksheetBtn = document.getElementById('submit-worksheet-btn');

        const editContent = document.getElementById('edit-content');
        // GANTI: 'worksheet-json-input' -> 'quiz-json-input'
        const quizJsonInput = document.getElementById('quiz-json-input'); 

        const submissionsContent = document.getElementById('submissions-content');
        const submissionsLoading = document.getElementById('submissions-loading');
        const submissionsEmpty = document.getElementById('submissions-empty');
        const submissionsList = document.getElementById('submissions-list');

        const toastMessage = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');


        /** 1. Fungsi Tampilan (UI) */

        // Tampilkan pesan notifikasi
        function showMessage(message, type = "success") {
            toastText.textContent = message;
            if (type === "error") {
                toastMessage.className = "fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white shadow-lg bg-red-500";
            } else {
                toastMessage.className = "fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white shadow-lg bg-green-600";
            }

            toastMessage.classList.remove('hidden');
            setTimeout(() => {
                toastMessage.classList.add('hidden');
            }, 3000);
        }

        // Tentukan peran (role) berdasarkan email
        function getRoleFromEmail(email) {
            if (!email) return 'mahasiswa';
            if (email.includes('dosen') || email.includes('guru')) {
                return 'dosen';
            }
            return 'mahasiswa';
        }
        
        // Render UI berdasarkan state login
        function renderUI(user) {
            if (user) {
                // Pengguna Login
                currentUser = user;
                userRole = getRoleFromEmail(user.email);
                
                userInfo.textContent = `Login sebagai: ${user.email} (${userRole})`;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');

                // Tampilkan UI khusus Dosen
                if (userRole === 'dosen') {
                    tabEdit.classList.remove('hidden');
                    tabSubmissions.classList.remove('hidden');
                    addMaterialBtn.classList.remove('hidden');
                    editTitleIconBtn.classList.remove('hidden');
                    submitWorksheetBtn.classList.add('hidden'); 
                    
                    // Inisialisasi TinyMCE satu kali (jika belum)
                    if (!isTinymceInitialized) {
                        console.log("Inisialisasi TinyMCE untuk Dosen...");
                        tinymce.init({
                            selector: '#reading-content-editor',
                            plugins: 'lists link image table code help wordcount autoresize',
                            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image | table | code',
                            height: 400,
                            menubar: false,
                            setup: (editor) => {
                                editor.on('init', () => {
                                    isTinymceInitialized = true;
                                    console.log('TinyMCE berhasil dimuat.');
                                });
                            }
                        });
                    }

                } else {
                    // Tampilan Mahasiswa
                    tabEdit.classList.add('hidden');
                    tabSubmissions.classList.add('hidden');
                    addMaterialBtn.classList.add('hidden');
                    editTitleIconBtn.classList.add('hidden');
                }
                
                // Mulai listener data
                initDataListeners();

                // Panggil createIcons SETELAH app-screen terlihat
                try {
                    lucide.createIcons();
                } catch(e) { console.warn("Lucide icons render fail on auth change", e) }

            } else {
                // Pengguna Logout
                currentUser = null;
                userRole = null;
                
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                loginError.textContent = "";
                loginForm.reset();
                
                // Hentikan listener data
                if (materialsListener) materialsListener();
                if (submissionsListener) submissionsListener();
                
                // Bersihkan UI
                materialsCache.clear();
                submissionsCache.clear();
                editTitleIconBtn.classList.add('hidden');
                resetUI();
            }
        }


        /** 2. Fungsi Autentikasi (Auth) */

        // Handle Login
        async function handleLogin(e) {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = "Mencoba login...";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.textContent = ""; 
            } catch (error) {
                console.error("Login Gagal:", error.code, error.message);
                if (error.code === 'auth/network-request-failed') {
                    loginError.textContent = "Gagal terhubung. Cek koneksi internet atau pengaturan domain di Firebase.";
                } 
                else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginError.textContent = "Email atau Password salah.";
                } else {
                    loginError.textContent = "Terjadi kesalahan. Coba lagi.";
                }
            }
        }

        // Handle Logout
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Gagal:", error);
            }
        }
        
        // Listener Status Auth
        function initAppSetup() {
             onAuthStateChanged(auth, (user) => {
                console.log("Status Auth berubah, user:", user ? user.email : 'null');
                renderUI(user);
            });
        }
        

        /** 3. Penanganan Data Materi (Firestore) - DIPERBARUI */

        // Mulai listener Firestore (hanya saat login)
        function initDataListeners() {
            console.log("Memulai listener data...");
            
            // 1. Listener untuk Materi
            if (materialsListener) materialsListener(); 
            const qMaterials = query(collection(db, materialsColPath));
            materialsListener = onSnapshot(qMaterials, onMaterialsUpdate, (error) => {
                console.error("Error mengambil materi:", error);
                if (error.code === 'permission-denied') {
                     materialListLoading.textContent = "Error: Izin ditolak (permission-denied). Cek Firestore Rules.";
                }
            });

            // 2. Listener untuk Nilai (Submissions)
            if (submissionsListener) submissionsListener();
            let qSubmissions;
            if (userRole === 'dosen') {
                qSubmissions = query(collection(db, submissionsColPath));
            } else {
                qSubmissions = query(collection(db, submissionsColPath), where("userId", "==", currentUser.uid));
            }
            submissionsListener = onSnapshot(qSubmissions, onSubmissionsUpdate, (error) => {
                 console.error("Error mengambil nilai:", error);
            });
        }
        
        // Callback saat data materi berubah - DIPERBARUI
        function onMaterialsUpdate(snapshot) {
            materialsCache.clear(); // Hapus cache lama
            let materialsArray = [];

            if (snapshot.empty && userRole === 'dosen') {
                setupInitialData();
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                let worksheetObject = null;
                
                // GANTI: 'worksheetJsonString' -> 'quizJsonString'
                // 'worksid' adalah typo, data lama mungkin masih pakai itu
                const jsonString = data.quizJsonString || data.worksheetJsonString || data.worksid || null;

                if (jsonString) {
                    try {
                        worksheetObject = JSON.parse(jsonString);
                    } catch (e) {
                        console.error(`JSON kuis tidak valid untuk materi ${doc.id}:`, e);
                    }
                }
                
                const material = {
                    id: doc.id,
                    title: data.title,
                    ebookUrl: data.ebookUrl || null,
                    // TAMBAHKAN: Field HTML baru
                    readingContentHTML: data.readingContentHTML || '',
                    // GANTI: Field JSON lama ke baru
                    quizJsonString: jsonString,
                    // 'worksheet' sekarang HANYA berisi kuis (atau JSON lama)
                    worksheet: worksheetObject 
                };
                
                materialsCache.set(doc.id, material);
                materialsArray.push(material);
            });

            // Urutkan materi
            const getSortKey = (titleOrId) => {
                const match = titleOrId.match(/(\d+)/);
                return match ? parseInt(match[1], 10) : 99;
            };
            materialsArray.sort((a, b) => {
                const keyA = getSortKey(a.id) || getSortKey(a.title);
                const keyB = getSortKey(b.id) || getSortKey(b.title);
                return keyA - keyB;
            });

            // Render daftar materi di sidebar
            renderMaterialList(materialsArray);
            
            // Jika ada materi yang sedang dilihat, refresh kontennya
            if (currentEditingMaterialId && materialsCache.has(currentEditingMaterialId)) {
                materialTitle.textContent = materialsCache.get(currentEditingMaterialId).title;
                const activeTab = document.querySelector('.tab-btn.text-blue-600').id.split('-')[1];
                showTab(activeTab);
            }
        }
        
        // Setup data awal jika database kosong - DIPERBARUI
        async function setupInitialData() {
            console.log("Database materi kosong. Membuat 12 materi awal...");
            const batch = writeBatch(db);
            const titles = [
                "Pertemuan 1: Introduction to Business English", "Pertemuan 2: Telephoning Skills",
                "Pertemuan 3: Business Correspondence (Emails)", "Pertemuan 4: Meetings and Discussions",
                "Pertemuan 5: Presentations Skills", "Pertemuan 6: UTS (Ujian Tengah Semester)",
                "Pertemuan 7: Negotiations", "Pertemuan 8: Business Vocabulary (Finance)",
                "Pertemuan 9: Business Vocabulary (Marketing)", "Pertemuan 10: Intercultural Communication",
                "Pertemuan 11: Review Materi", "Pertemuan 12: UAS (Ujian Akhir Semester)"
            ];

            titles.forEach((title, index) => {
                const docId = `materi-${index + 1}`;
                const docRef = doc(db, materialsColPath, docId);
                batch.set(docRef, {
                    title: title,
                    ebookUrl: null,
                    readingContentHTML: "", // Field HTML baru
                    quizJsonString: null // Field Kuis baru
                });
            });

            try {
                await batch.commit();
                console.log("12 materi awal berhasil dibuat.");
            } catch (error) {
                console.error("Gagal membuat data awal:", error);
            }
        }
        
        // Render daftar materi di sidebar
        function renderMaterialList(materials) {
            materialList.innerHTML = '';
            if (materials.length === 0) {
                materialListLoading.textContent = "Belum ada materi.";
                materialListLoading.classList.remove('hidden');
                return;
            }
            
            materialListLoading.classList.add('hidden');
            
            materials.forEach(material => {
                const li = document.createElement('li');
                li.className = `p-3 rounded-lg cursor-pointer transition duration-200 ${
                    currentEditingMaterialId === material.id 
                        ? 'bg-blue-100 text-blue-700 font-semibold' 
                        : 'hover:bg-gray-100'
                }`;
                li.textContent = material.title;
                li.setAttribute('data-id', material.id);
                li.addEventListener('click', () => selectMaterial(material.id));
                materialList.appendChild(li);
            });
        }
        
        // Handle klik tambah materi (Dosen) - DIPERBARUI
        async function handleAddMaterial() {
            const title = prompt("Masukkan judul materi baru:", `Pertemuan ${materialsCache.size + 1}`);
            if (title && title.trim() !== "") {
                try {
                    const newId = `materi-${Date.now()}`;
                    const docRef = doc(db, materialsColPath, newId);
                    await setDoc(docRef, {
                        title: title.trim(),
                        ebookUrl: null,
                        readingContentHTML: "", // Field HTML baru
                        quizJsonString: null // Field Kuis baru
                    });
                    showMessage("Materi baru berhasil ditambahkan.", "success");
                } catch (error) {
                    console.error("Error menambah materi:", error);
                    showMessage("Gagal menambah materi.", "error");
                }
            }
        }
        
        // Handle Edit Judul (Dosen)
        async function handleEditTitle() {
            if (!currentEditingMaterialId) return;
            const material = materialsCache.get(currentEditingMaterialId);
            if (!material) return;

            const currentTitle = material.title;
            const newTitle = prompt("Masukkan judul materi baru:", currentTitle);

            if (newTitle && newTitle.trim() !== "" && newTitle.trim() !== currentTitle) {
                try {
                    const docRef = doc(db, materialsColPath, currentEditingMaterialId);
                    await updateDoc(docRef, {
                        title: newTitle.trim()
                    });
                    showMessage("Judul materi berhasil diperbarui.", "success");
                } catch (error) {
                    console.error("Error updating title:", error);
                    showMessage("Gagal memperbarui judul.", "error");
                }
            }
        }


        /** 4. Penanganan Tampilan Detail Materi */
        
        // Handle saat materi dipilih dari daftar
        function selectMaterial(materialId) {
            currentEditingMaterialId = materialId;
            const material = materialsCache.get(materialId);
            if (!material) return;

            // Update UI daftar materi (highlight)
            document.querySelectorAll('#material-list li').forEach(li => {
                li.classList.toggle('bg-blue-100', li.getAttribute('data-id') === materialId);
                li.classList.toggle('text-blue-700', li.getAttribute('data-id') === materialId);
                li.classList.toggle('font-semibold', li.getAttribute('data-id') === materialId);
            });
            
            // Tampilkan detail
            welcomeMessage.classList.add('hidden');
            materialDetail.classList.remove('hidden');
            materialTitle.textContent = material.title;

            // Tampilkan tab default (Worksheet)
            showTab('worksheet');
        }
        
        // Handle ganti tab - DIPERBARUI
        window.showTab = (tabName) => {
            // Sembunyikan semua konten tab
            worksheetContent.classList.add('hidden');
            editContent.classList.add('hidden');
            submissionsContent.classList.add('hidden');

            // Atur style tombol tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-500');
                btn.classList.add('text-gray-500', 'border-transparent');
            });

            // Tampilkan tab yang dipilih
            if (tabName === 'worksheet') {
                worksheetContent.classList.remove('hidden');
                document.getElementById('tab-worksheet').classList.add('text-blue-600', 'border-blue-500');
                renderWorksheet(currentEditingMaterialId);
                try { lucide.createIcons(); } catch(e) {}
                
            } else if (tabName === 'edit' && userRole === 'dosen') {
                editContent.classList.remove('hidden');
                document.getElementById('tab-edit').classList.add('text-blue-600', 'border-blue-500');
                
                // Muat data ke editor
                const material = materialsCache.get(currentEditingMaterialId);
                
                // Muat ke Rich Text Editor
                if (isTinymceInitialized && tinymce.get('reading-content-editor')) {
                    tinymce.get('reading-content-editor').setContent(material.readingContentHTML || '');
                } else {
                    // Jika editor belum siap, coba muat ke textarea mentah
                    document.getElementById('reading-content-editor').value = material.readingContentHTML || '';
                }

                // Muat ke input Link eBook
                document.getElementById('ebook-url-input').value = material.ebookUrl || '';
                
                // Muat ke Textarea JSON Kuis
                quizJsonInput.value = material.quizJsonString || '';
                
            } else if (tabName === 'submissions' && userRole === 'dosen') {
                submissionsContent.classList.remove('hidden');
                document.getElementById('tab-submissions').classList.add('text-blue-600', 'border-blue-500');
                renderSubmissions(currentEditingMaterialId);
            }
        }
        
        // Reset UI saat logout
        function resetUI() {
            welcomeMessage.classList.remove('hidden');
            materialDetail.classList.add('hidden');
            materialList.innerHTML = '';
            materialListLoading.textContent = "Memuat materi...";
            materialListLoading.classList.remove('hidden');
            editTitleIconBtn.classList.add('hidden');
            currentEditingMaterialId = null;
        }

        /** 5. Penanganan Lembar Kerja (Worksheet) - FUNGSI DIPERBARUI */
        
        // Render soal di tab "Lembar Kerja" - DIPERBARUI
        function renderWorksheet(materialId) {
            const material = materialsCache.get(materialId);
            const userSubmission = submissionsCache.get(getSubmissionId(materialId));
            const ebookLinkContainer = document.getElementById('ebook-link-container');
            const ebookLinkBtn = document.getElementById('ebook-link-btn');

            // Kosongkan kontainer
            worksheetFormContainer.innerHTML = ''; 
            worksheetReadingContent.innerHTML = '';
            ebookLinkContainer.classList.add('hidden');
            
            worksheetLoading.classList.remove('hidden');
            worksheetEmpty.classList.add('hidden');
            worksheetFormContainer.classList.add('hidden');
            submitWorksheetBtn.classList.add('hidden');

            if (!material) {
                worksheetLoading.classList.add('hidden');
                worksheetEmpty.classList.remove('hidden');
                return;
            }

            // --- Render Link eBook ---
            if (material.ebookUrl) {
                ebookLinkBtn.href = material.ebookUrl;
                ebookLinkContainer.classList.remove('hidden');
            }

            // --- Render Materi Bacaan (Format BARU: HTML) ---
            let hasReadingContent = false;
            if (material.readingContentHTML && material.readingContentHTML.trim() !== '') {
                worksheetReadingContent.innerHTML = material.readingContentHTML;
                hasReadingContent = true;
            } 
            // --- Fallback ke Format LAMA (JSON 'sections') ---
            else if (material.worksheet && material.worksheet.sections) {
                console.log("Merender materi bacaan dari format JSON lama (sections)...");
                hasReadingContent = true; // Tandai bahwa ada konten
                // (Logika parsing JSON 'sections' lama tetap dipertahankan untuk kompatibilitas)
                if (material.worksheet.module_description) {
                    const desc = document.createElement('p');
                    desc.className = 'text-lg italic text-gray-600 mb-6';
                    desc.textContent = material.worksheet.module_description;
                    worksheetReadingContent.appendChild(desc);
                }
                if (material.worksheet.sections && Array.isArray(material.worksheet.sections)) {
                    material.worksheet.sections.forEach(section => {
                        const sectionTitle = document.createElement('h3');
                        sectionTitle.textContent = section.section_title;
                        worksheetReadingContent.appendChild(sectionTitle);
                        // ... (sisa logika parsing list, table, text dari JSON) ...
                    });
                }
            }


            // --- Render Kuis (Format Lama & Baru) ---
            const questions = material.worksheet ? material.worksheet.questions : null;
            
            if (!questions || questions.length === 0) {
                // Jika tidak ada kuis
                if (hasReadingContent || material.ebookUrl) {
                    // Ada materi bacaan atau ebook, tapi tidak ada kuis
                    worksheetLoading.classList.add('hidden');
                    worksheetEmpty.classList.add('hidden');
                    // Tampilkan saja materi bacaan (sudah di-render di atas)
                    worksheetReadingContent.classList.remove('hidden'); 
                } else {
                    // Tidak ada kuis, tidak ada materi, tidak ada ebook
                    worksheetLoading.classList.add('hidden');
                    worksheetEmpty.classList.remove('hidden');
                }
                return; // Berhenti
            }

            // Jika ADA KUIS
            worksheetFormContainer.classList.remove('hidden');

            // Tambahkan materi bacaan (HTML atau JSON lama) ke form container
            worksheetFormContainer.appendChild(worksheetReadingContent);

            // Jika ada materi bacaan, tambahkan pemisah
            if (hasReadingContent) {
                 const hr = document.createElement('hr');
                 hr.className = 'my-8 border-t-2 border-gray-200';
                 worksheetFormContainer.appendChild(hr);
                 
                 const quizTitle = document.createElement('h3');
                 quizTitle.textContent = "Kuis / Lembar Kerja";
                 quizTitle.className = 'text-2xl font-bold mb-6';
                 worksheetFormContainer.appendChild(quizTitle);
            }

            // Buat form kuis
            const form = document.createElement('form');
            form.id = 'worksheet-form';
            form.className = 'space-y-6';

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 border border-gray-200 rounded-lg bg-white';
                
                const questionStr = q.question || q.question_text;
                const questionText = document.createElement('p');
                questionText.className = 'text-base font-medium text-gray-900 mb-3';
                questionText.textContent = `${index + 1}. ${questionStr}`;
                questionDiv.appendChild(questionText);

                const answerContainer = document.createElement('div');
                const savedAnswer = userSubmission?.answers?.[index] || '';
                const qType = q.type || q.question_type;

                if (qType === 'multiple_choice' && q.options) {
                    answerContainer.className = 'space-y-2';
                    q.options.forEach((option) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center p-3 rounded-md border border-gray-200 hover:bg-gray-50 cursor-pointer';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `question-${index}`;
                        input.value = option;
                        input.className = 'h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500';
                        if (option === savedAnswer) input.checked = true;
                        const span = document.createElement('span');
                        span.textContent = option;
                        span.className = 'ml-3 text-sm text-gray-700';
                        label.appendChild(input);
                        label.appendChild(span);
                        answerContainer.appendChild(label);
                    });
                } 
                else if (qType === 'true_false') {
                    answerContainer.className = 'space-y-2';
                    const options = ["True", "False"];
                    options.forEach((option) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center p-3 rounded-md border border-gray-200 hover:bg-gray-50 cursor-pointer';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `question-${index}`;
                        input.value = option;
                        input.className = 'h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500';
                        if (option.toLowerCase() === String(savedAnswer).toLowerCase()) input.checked = true;
                        const span = document.createElement('span');
                        span.textContent = option;
                        span.className = 'ml-3 text-sm text-gray-700';
                        label.appendChild(input);
                        label.appendChild(span);
                        answerContainer.appendChild(label);
                    });
                }
                else if (qType === 'fill_in_the_blank') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `question-${index}`;
                    input.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500';
                    input.placeholder = 'Ketik jawaban Anda...';
                    input.value = savedAnswer;
                    answerContainer.appendChild(input);
                }
                
                questionDiv.appendChild(answerContainer);
                form.appendChild(questionDiv);
            });
            
            worksheetFormContainer.appendChild(form);
            
            // Tampilkan form
            worksheetLoading.classList.add('hidden');
            worksheetEmpty.classList.add('hidden');
            
            if (userRole === 'mahasiswa') {
                submitWorksheetBtn.classList.remove('hidden');
            }
        }
        
        // Handle Simpan Worksheet (Dosen) - DIPERBARUI
        async function handleSaveWorksheet() {
            if (!currentEditingMaterialId) {
                showMessage("Tidak ada materi yang dipilih.", "error");
                return;
            }

            // 1. Ambil data HTML dari Rich Text Editor
            let htmlContent = '';
            if (isTinymceInitialized && tinymce.get('reading-content-editor')) {
                htmlContent = tinymce.get('reading-content-editor').getContent();
            } else {
                // Fallback jika TinyMCE gagal (ambil dari textarea mentah)
                htmlContent = document.getElementById('reading-content-editor').value;
            }
            
            // 2. Ambil data Link eBook
            const ebookUrlInput = document.getElementById('ebook-url-input').value.trim();
            
            // 3. Ambil data JSON Kuis
            const jsonInput = quizJsonInput.value.trim();
            let jsonString = null; // Ini yang akan disimpan ke DB

            if (jsonInput === "") {
                // Jika input kuis dikosongkan, simpan sebagai null
                jsonString = null;
            } else {
                // Jika ada input, coba parse
                try {
                    const parsedData = JSON.parse(jsonInput);
                    // Validasi struktur (HANYA cek 'questions')
                    if (parsedData && parsedData.questions && !Array.isArray(parsedData.questions)) {
                        const errorMsg = "Format JSON Kuis tidak valid. Key 'questions' harus berupa array.";
                        showMessage(errorMsg, "error");
                        return; // Hentikan
                    }
                } catch (e) {
                    // Tangani jika JSON-nya sendiri tidak valid (syntax error)
                    showMessage(`Error: JSON Kuis tidak valid. Cek sintaks. (${e.message})`, "error");
                    return;
                }
                
                // Jika valid, simpan sebagai string
                jsonString = jsonInput;
            }

            // 4. Siapkan data untuk disimpan
            const dataToSave = {
                readingContentHTML: htmlContent,  // Field HTML baru
                ebookUrl: ebookUrlInput || null,   // Field Ebook
                quizJsonString: jsonString         // Field Kuis baru
                // Kita tidak lagi menyimpan 'worksid' atau 'worksheetJsonString'
            };

            try {
                // Simpan data
                const docRef = doc(db, materialsColPath, currentEditingMaterialId);
                // Gunakan setDoc + merge: true agar menimpa field lama (seperti worksheetJsonString)
                // dan memperbarui field yang ada (seperti title)
                await setDoc(docRef, dataToSave, { merge: true }); 

                showMessage("Materi dan kuis berhasil disimpan.", "success");
                
            } catch (error) {
                console.error("Error saving worksheet:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Error: Anda (dosen) tidak punya izin menyimpan materi.", "error");
                } else {
                    showMessage("Gagal menyimpan materi.", "error");
                }
            }
        }

        // Handle Simpan Jawaban (Mahasiswa) - (Fungsi ini tidak perlu diubah)
        async function handleSubmitWorksheet() {
            if (!currentEditingMaterialId || !currentUser) return;
            const material = materialsCache.get(currentEditingMaterialId);
            if (!material || !material.worksheet || !material.worksheet.questions || material.worksheet.questions.length === 0) {
                showMessage("Materi ini tidak memiliki kuis untuk disimpan.", "error");
                return;
            }

            const form = document.getElementById('worksheet-form');
            if (!form) return;

            const answers = [];
            let totalQuestions = 0;
            let score = 0;
            
            material.worksheet.questions.forEach((q, index) => {
                totalQuestions++;
                const inputs = form.elements[`question-${index}`];
                let userAnswer = '';
                const qType = q.type || q.question_type;
                
                if (qType === 'multiple_choice' || qType === 'true_false') {
                    if (inputs.value) userAnswer = inputs.value;
                } else if (qType === 'fill_in_the_blank') {
                    if (inputs.value) userAnswer = inputs.value.trim();
                }
                
                answers.push(userAnswer);

                // --- Logika Penilaian ---
                let correctAnswerText = '';
                if (q.answer !== undefined) {
                    correctAnswerText = String(q.answer).trim();
                } else if (q.correct_answer !== undefined) {
                    if (qType === 'multiple_choice' && q.options) {
                        correctAnswerText = String(q.options[q.correct_answer]).trim();
                    } else if (qType === 'true_false') {
                        correctAnswerText = String(q.correct_answer).trim();
                    }
                }
                
                if (userAnswer.toLowerCase() === correctAnswerText.toLowerCase()) {
                    score++;
                }
            });
            
            const finalGrade = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            
            const submissionData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                materialId: currentEditingMaterialId,
                materialTitle: material.title,
                answers: answers,
                score: finalGrade,
                submittedAt: new Date()
            };
            
            try {
                const submissionId = getSubmissionId(currentEditingMaterialId);
                const docRef = doc(db, submissionsColPath, submissionId);
                await setDoc(docRef, submissionData, { merge: true });
                showMessage(`Jawaban berhasil disimpan! Skor Anda: ${finalGrade}`, "success");
            } catch (error) {
                console.error("Error submitting worksheet:", error);
                showMessage("Gagal menyimpan jawaban.", "error");
            }
        }


        /** 6. Penanganan Nilai (Submissions) */
        
        // Buat ID submission yang unik per (user, materi)
        function getSubmissionId(materialId) {
            if (!currentUser) return null;
            return `${currentUser.uid}_${materialId}`;
        }
        
        // Callback saat data nilai berubah
        function onSubmissionsUpdate(snapshot) {
            submissionsCache.clear();
            snapshot.forEach(doc => {
                submissionsCache.set(doc.id, doc.data());
            });

            // Jika tab rekap nilai sedang aktif, render ulang
            if (currentEditingMaterialId && !submissionsContent.classList.contains('hidden')) {
                renderSubmissions(currentEditingMaterialId);
            }
            
            // Jika tab lembar kerja sedang aktif, render ulang
             if (currentEditingMaterialId && !worksheetContent.classList.contains('hidden')) {
                renderWorksheet(currentEditingMaterialId);
            }
        }
        
        // Render rekap nilai (Dosen)
        function renderSubmissions(materialId) {
            submissionsList.innerHTML = '';
            submissionsLoading.classList.remove('hidden');
            submissionsEmpty.classList.add('hidden');

            const relevantSubmissions = [];
            submissionsCache.forEach(sub => {
                if (sub.materialId === materialId) {
                    relevantSubmissions.push(sub);
                }
            });

            if (relevantSubmissions.length === 0) {
                submissionsLoading.classList.add('hidden');
                submissionsEmpty.classList.remove('hidden');
                return;
            }

            relevantSubmissions.sort((a, b) => a.userEmail.localeCompare(b.userEmail));
            submissionsLoading.classList.add('hidden');

            relevantSubmissions.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg flex justify-between items-center';
                const userInfo = document.createElement('div');
                const email = document.createElement('p');
                email.className = 'font-medium text-gray-800';
                email.textContent = sub.userEmail;
                userInfo.appendChild(email);
                const date = document.createElement('p');
                date.className = 'text-xs text-gray-500';
                date.textContent = `Dikerjakan: ${sub.submittedAt.toDate().toLocaleString()}`;
                userInfo.appendChild(date);
                div.appendChild(userInfo);
                const score = document.createElement('div');
                score.className = `text-2xl font-bold ${sub.score >= 70 ? 'text-green-600' : 'text-red-600'}`;
                score.textContent = sub.score;
                div.appendChild(score);
                submissionsList.appendChild(div);
            });
        }
        

        /** 7. Inisialisasi Event Listeners */
        
        try {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('tab-worksheet').addEventListener('click', () => showTab('worksheet'));
            document.getElementById('tab-edit').addEventListener('click', () => showTab('edit'));
            document.getElementById('tab-submissions').addEventListener('click', () => showTab('submissions'));
            document.getElementById('save-worksheet-btn').addEventListener('click', handleSaveWorksheet);
            document.getElementById('edit-title-icon-btn').addEventListener('click', handleEditTitle);
            document.getElementById('submit-worksheet-btn').addEventListener('click', handleSubmitWorksheet);
            document.getElementById('add-material-btn').addEventListener('click', handleAddMaterial);
        } catch (e) {
            console.error("Gagal memasang listener:", e);
        }

        // Panggil createIcons (FIX: Panggil di DOMContentLoaded agar 'defer' selesai)
        document.addEventListener('DOMContentLoaded', () => {
            try {
                lucide.createIcons();
            } catch (e) {
                console.error("Gagal memuat ikon Lucide:", e);
            }
        });


        // Inisialisasi status Autentikasi
        initAppSetup();

    </script>
</body>

</html>



