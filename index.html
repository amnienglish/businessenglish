<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business English LMS</title>
    <!-- Muat Tailwind CSS dengan plugin typography -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Muat Ikon Lucide (FIX: Tambahkan 'defer' agar tidak block) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Muat TinyMCE (Rich Text Editor) (FIX: Tambahkan 'defer') -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.3/tinymce.min.js"
        referrerpolicy="origin"></script>

    <style>
        /* Style kustom untuk LMS */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Sembunyikan scrollbar untuk sidebar */
        #material-list::-webkit-scrollbar {
            display: none;
        }

        #material-list {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Loading spinner */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- CSS Statis untuk Firefly (Kunang-kunang) --- */
        .firefly {
            position: fixed;
            left: 50%;
            top: 50%;
            width: 0.4vw;
            height: 0.4vw;
            margin: -0.2vw 0 0 9.8vw;
            animation: ease 200s alternate infinite;
            pointer-events: none;
        }

        .firefly::before,
        .firefly::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform-origin: -10vw;
        }

        .firefly::before {
            background: black;
            opacity: 0.4;
            animation: drift ease alternate infinite;
        }

        .firefly::after {
            background: white;
            opacity: 0;
            box-shadow: 0 0 0vw 0vw yellow;
            animation: drift ease alternate infinite, flash ease infinite;
        }

        @keyframes drift {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes flash {

            0%,
            30%,
            100% {
                opacity: 0;
                box-shadow: 0 0 0vw 0vw yellow;
            }

            5% {
                opacity: 1;
                box-shadow: 0 0 2vw 0.4vw yellow;
            }
        }
    </style>
</head>

<body class="bg-gray-100 antialiased">

    <!-- Kontainer Aplikasi Utama -->
    <div id="app-container" class="h-screen w-screen flex">

        <!-- 1. Halaman Login (Awalnya terlihat) -->
        <div id="login-screen"
            class="w-full h-full flex items-center justify-center relative overflow-hidden"
            style="background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-Rtlv_IEgPoAzdKbnoL4sCLTgm8ZwsOBNy_GvPLHBBCLdnz-RidUVPapxKT8-0YUgDtTizkzD-On909KnXPMr0N7_-oBfBQiRdpuWWdy8qN2x1yZFrLw001DSnE21ru11Gv80jxiG7ozhATxDI_yRDNabUp1Bb4BRhnmljUr4D8l1HtlxA5p84pDDwmFD/s5803/anime-night-sky-illustration.jpg'); background-size: cover; background-position: center;">

            <!-- Elemen Firefly (15) -->
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>

            <!-- Kartu Login (Transparan) -->
            <div class="w-full max-w-md p-8 bg-white/10 backdrop-blur-md rounded-xl shadow-lg border border-white/20 z-10">
                <h2 class="text-3xl font-bold text-center text-white mb-2">Business English LMS</h2>
                <p class="text-center text-gray-200 mb-8">Silakan login untuk melanjutkan</p>

                <div id="login-error" class="hidden text-red-600 bg-red-50 p-3 rounded-lg text-sm mb-4"></div>

                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-200 mb-1">Email</label>
                        <input type="email" id="email"
                            class="w-full px-4 py-2 bg-transparent border border-gray-400 rounded-lg text-white placeholder-gray-300 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="cth: xxx@email.com" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-200 mb-1">Password</label>
                        <input type="password" id="password"
                            class="w-full px-4 py-2 bg-transparent border border-gray-400 rounded-lg text-white placeholder-gray-300 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••" required>
                    </div>
                    <button type="submit" id="login-button"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        Login
                    </button>
                </form>
            </div>
        </div>

        <!-- 2. Halaman Dashboard (Awalnya tersembunyi) -->
        <div id="dashboard-screen" class="hidden w-full h-full flex">
            <!-- Sidebar (Daftar Materi) -->
            <div class="w-1/4 max-w-xs h-full bg-white border-r border-gray-200 flex flex-col shadow-sm">
                <!-- Header Sidebar -->
                <div class="p-4 border-b border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800">Materi Kuliah</h1>
                    <p id="user-role-display" class="text-sm text-gray-500">Role: <span
                            class="font-medium text-gray-700"></span></p>
                </div>

                <!-- Kontainer Tombol Tambah Materi (Hanya Dosen) -->
                <div id="add-material-container" class="hidden p-4 border-b border-gray-200">
                    <button id="add-material-btn"
                        class="w-full flex items-center justify-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-100 transition">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Tambah Materi Baru
                    </button>
                </div>

                <!-- Daftar Materi (Bisa di-scroll) -->
                <div id="material-list" class="flex-1 overflow-y-auto p-2">
                    <!-- Materi akan di-render oleh JS di sini -->
                </div>

                <!-- Footer Sidebar (Info User & Logout) -->
                <div class="p-4 border-t border-gray-200 mt-auto">
                    <div class="mb-3">
                        <p class="text-xs text-gray-500">Login sebagai:</p>
                        <p id="user-email-display" class="text-sm font-medium text-gray-800 truncate"
                            title="user@example.com"></p>
                    </div>
                    <button id="logout-button"
                        class="w-full flex items-center justify-center gap-2 text-sm text-red-600 bg-red-50 px-4 py-2 rounded-lg hover:bg-red-100 transition">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Logout
                    </button>
                </div>
            </div>

            <!-- Konten Utama (Detail Materi) -->
            <div class="w-3/4 flex-1 h-full bg-gray-50 flex flex-col">
                <!-- Header Konten Utama -->
                <div class="p-5 border-b border-gray-200 bg-white shadow-sm">
                    <!-- Judul Materi dan Ikon Edit Judul (Dosen) -->
                    <div class="flex items-center gap-2">
                        <h2 id="material-title" class="text-2xl font-bold text-gray-800">
                            Pilih materi dari daftar di sebelah kiri
                        </h2>
                        <!-- Ikon Edit Judul (Hanya Dosen) -->
                        <button id="edit-title-btn"
                            class="hidden text-gray-400 hover:text-blue-600 transition p-1 rounded-md" title="Edit Judul">
                            <i data-lucide="pencil" class="w-5 h-5"></i>
                        </button>
                        <!-- Ikon Hapus Materi (Hanya Dosen) - BARU -->
                        <button id="delete-material-btn"
                            class="hidden text-gray-400 hover:text-red-600 transition p-1 rounded-md" title="Hapus Materi">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Navigasi Tab (Lembar Kerja, Edit, Rekap) -->
                    <div id="material-tabs" class="hidden mt-4 border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6">
                            <button data-tab="worksheet"
                                class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Lembar Kerja
                            </button>
                            <!-- Tab Mahasiswa -->
                            <button data-tab="student-recap"
                                class="tab-button tab-button-mahasiswa hidden whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Rekap Nilai Saya
                            </button>
                            <!-- Tab Dosen -->
                            <button data-tab="edit"
                                class="tab-button tab-button-dosen hidden whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Edit Worksheet
                            </button>
                            <button data-tab="recap"
                                class="tab-button tab-button-dosen hidden whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Rekap Nilai & Tugas
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Area Konten Tab (Bisa di-scroll) -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="worksheet-content" class="max-w-3xl mx-auto">

                        <!-- State: Loading -->
                        <div id="worksheet-loading" class="hidden text-center py-10">
                            <div class="spinner w-12 h-12 rounded-full border-4 border-gray-200 border-t-blue-500 mx-auto">
                            </div>
                            <p class="mt-4 text-gray-500">Memuat materi...</p>
                        </div>

                        <!-- State: Belum memilih materi -->
                        <div id="worksheet-empty" class="text-center py-20">
                            <i data-lucide="book-open" class="w-16 h-16 text-gray-300 mx-auto"></i>
                            <p class="mt-4 text-gray-500">Materi yang dipilih akan tampil di sini.</p>
                        </div>

                        <!-- 
                          Konten Tab: Lembar Kerja (Mahasiswa & Dosen)
                        -->
                        <div id="worksheet-details" class="hidden">
                            <!-- Link eBook (Jika ada) -->
                            <div id="ebook-link-container" class="hidden mb-6">
                                <a id="ebook-link" href="#" target="_blank"
                                    class="inline-flex items-center gap-2 bg-indigo-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-sm">
                                    <i data-lucide="book-marked" class="w-5 h-5"></i>
                                    Buka Materi eBook
                                </a>
                            </div>

                            <!-- Konten Materi Bacaan (Rich Text / HTML) -->
                            <div id="worksheet-reading-content"
                                class="hidden prose prose-lg max-w-none bg-white p-6 rounded-lg border border-gray-200 mb-6">
                                <!-- Konten Rich Text (HTML) akan di-render di sini -->
                            </div>

                            <!-- Konten Form Kuis -->
                            <div id="worksheet-form-container" class="hidden">
                                <!-- Soal akan di-render di sini -->
                            </div>

                            <!-- Form Upload Tugas (Link) - BARU -->
                            <div id="task-submission-container" class="hidden mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-800 mb-2">Pengumpulan Tugas</h3>
                                <p class="text-sm text-blue-600 mb-4">
                                    Silakan copy url-nya di sini, pastikan akses link dibuka untuk umum (Anyone with the link), lalu tempel linknya di bawah ini.
                                </p>
                                <label for="task-url-input" class="block text-sm font-medium text-gray-700 mb-1">Link Tugas</label>
                                <input type="url" id="task-url-input" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="https://...">
                            </div>

                            <button id="submit-worksheet-btn"
                                class="hidden mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                Simpan Jawaban & Tugas
                            </button>

                            <!-- KARTU SKOR (BARU) - Ditampilkan setelah kuis disimpan -->
                            <div id="worksheet-score-card"
                                class="hidden text-center p-8 bg-green-50 rounded-lg border border-green-200 mt-6">
                                <i data-lucide="check-circle" class="h-16 w-16 text-green-500 mx-auto mb-4"></i>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Jawaban Telah Disimpan!</h3>
                                <div id="score-display-container">
                                    <p class="text-lg text-gray-600 mb-4">Skor Kuis Anda:</p>
                                    <p id="score-card-text" class="text-6xl font-bold text-green-600">0</p>
                                </div>
                                <div id="task-submitted-msg" class="hidden mt-4 text-blue-700 font-medium">
                                    <i data-lucide="link" class="inline w-4 h-4 mr-1"></i> Link tugas berhasil dikirim.
                                </div>
                            </div>
                        </div>


                        <!-- Konten Tab: Edit Worksheet (Dosen) - DIPERBARUI -->
                        <div id="edit-content" class="hidden">
                            <!-- Input Link eBook -->
                            <div class="mb-6">
                                <label for="ebook-url-input" class="block text-sm font-medium text-gray-700 mb-1">
                                    Link eBook (Opsional)
                                </label>
                                <input type="url" id="ebook-url-input"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="https://drive.google.com/...">
                            </div>

                            <!-- Checkbox Aktifkan Tugas (BARU) -->
                            <div class="mb-6 flex items-center p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <input type="checkbox" id="enable-task-submission" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                <label for="enable-task-submission" class="ml-3 block text-sm font-medium text-gray-700">
                                    Wajibkan Pengumpulan Tugas (Link Google Drive)
                                </label>
                            </div>

                            <!-- Editor Materi Bacaan (Rich Text) -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Materi Bacaan (Rich Text Editor)
                                </label>
                                <textarea id="reading-content-editor" class="w-full h-64"></textarea>
                            </div>

                            <!-- Editor Kuis (JSON) -->
                            <div>
                                <label for="worksheet-json-input"
                                    class="block text-sm font-medium text-gray-700 mb-1">
                                    Kuis (Format JSON)
                                </label>
                                <textarea id="worksheet-json-input"
                                    class="w-full h-96 p-4 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder='{ "questions": [ ... ] }'></textarea>
                            </div>

                            <button id="save-worksheet-btn"
                                class="mt-6 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                Simpan Perubahan
                                </button>
                        </div>

                        <!-- Konten Tab: Rekap Nilai (Dosen) -->
                        <div id="recap-content" class="hidden">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Rekap Nilai: <span
                                    id="recap-material-title"></span></h3>
                            <div id="recap-loading" class="hidden text-gray-500">Memuat rekap...</div>
                            <div id="recap-no-data" class="hidden text-gray-500">Belum ada mahasiswa yang mengerjakan.
                            </div>
                            <div class="overflow-x-auto">
                                <table id="recap-table" class="hidden min-w-full bg-white rounded-lg shadow">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Kuis</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Tugas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                            <!-- KOLOM AKSI (RESET) -->
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recap-table-body" class="divide-y divide-gray-200">
                                        <!-- Data rekap akan di-render oleh JS di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Konten Tab: Rekap Nilai Mahasiswa (BARU) -->
                        <div id="student-recap-content" class="hidden">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Rekap Nilai Anda</h3>
                            <div id="student-recap-loading" class="hidden text-gray-500">Memuat rekap...</div>
                            <div id="student-recap-no-data" class="hidden text-gray-500">Anda belum mengerjakan kuis
                                apapun.</div>
                            <table id="student-recap-table"
                                class="hidden min-w-full bg-white rounded-lg shadow overflow-hidden">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Materi</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Skor</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Waktu Mengerjakan</th>
                                    </tr>
                                </thead>
                                <tbody id="student-recap-table-body" class="divide-y divide-gray-200">
                                    <!-- Data rekap akan di-render oleh JS di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifikasi Toast -->
        <div id="toast-notification"
            class="hidden fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white transition-transform translate-y-16 opacity-0 duration-300">
            <span id="toast-message"></span>
        </div>
    </div>


    <!-- =============================================== -->
    <!-- MODUL JAVASCRIPT DAN FIREBASE -->
    <!-- =============================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuxnDKTGfelPzVtmUgk0txMOiV8Z-fG8A",
            authDomain: "business-english-34e6b.firebaseapp.com",
            projectId: "business-english-34e6b",
            storageBucket: "business-english-34e6b.firebasestorage.app",
            messagingSenderId: "790922726030",
            appId: "1:790922726030:web:b65d9a57024e303f1817df",
            measurementId: "G-6C7K6LKWP8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let userRole = null;
        let currentUserId = null;
        let currentEditingMaterialId = null;
        let materialsCache = new Map();
        let submissionsCache = new Map();
        let usersCache = new Map();

        // --- DOM Elements ---
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const addMaterialBtn = document.getElementById('add-material-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');
        const deleteMaterialBtn = document.getElementById('delete-material-btn'); // NEW BUTTON
        const saveWorksheetBtn = document.getElementById('save-worksheet-btn');
        const submitWorksheetBtn = document.getElementById('submit-worksheet-btn');
        const tabButtons = document.querySelectorAll('.tab-button');

        // --- HELPERS ---
        function showMessage(msg, type='success') {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-message').textContent = msg;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white transition-transform duration-300 translate-y-0 opacity-100 ${type==='success'?'bg-green-600':'bg-red-600'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('translate-y-16', 'opacity-0'); setTimeout(()=>toast.classList.add('hidden'),300); }, 3000);
        }

        function createFireflyAnimations() {
            let css = '';
            for(let i=1; i<=15; i++) {
                const dur = (Math.random()*10+8).toFixed(2)+'s';
                css += `.firefly:nth-child(${i}) { animation-name: move${i}; } .firefly:nth-child(${i})::before { animation-duration: ${dur}; }`;
                css += `@keyframes move${i} { 0% { transform: translateX(${(Math.random()*100-50).toFixed(0)}vw) translateY(${(Math.random()*100-50).toFixed(0)}vh) scale(${Math.random()}); } 100% { transform: translateX(${(Math.random()*100-50).toFixed(0)}vw) translateY(${(Math.random()*100-50).toFixed(0)}vh) scale(${Math.random()}); } }`;
            }
            const s = document.createElement('style'); s.innerHTML = css; document.head.appendChild(s);
        }

        function getStudentName(email) {
            if (email.includes('240508007')) return 'YOPIG MERZI PRASTIKO';
            if (email.includes('240508003')) return 'M. FAJAR RAHINO';
            if (email.includes('240508005')) return 'Moses Angga Tambunan';
            return email.split('@')[0];
        }

        // --- CORE FUNCTIONS ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                const errBox = document.getElementById('login-error');
                errBox.classList.remove('hidden');
                if (err.code === 'auth/network-request-failed') errBox.textContent = "Gagal koneksi. Cek internet/firewall.";
                else errBox.textContent = "Email/Password salah.";
            }
        }

        async function handleLogout() {
            await signOut(auth);
            window.location.reload();
        }

        async function saveUserData(user) {
            try {
                const role = (user.email.includes('dosen') || user.email.includes('guru')) ? 'dosen' : 'mahasiswa';
                const name = (role === 'mahasiswa') ? getStudentName(user.email) : user.email.split('@')[0];
                await setDoc(doc(db, "users", user.uid), { email: user.email, role, displayName: name }, { merge: true });
                return role;
            } catch (e) { console.warn("Save user fail:", e); return 'mahasiswa'; }
        }

        // Expose to window for inline onclick in table
        window.handleResetSubmission = async function(submissionId, studentName) {
            if(confirm(`Apakah Anda yakin ingin mereset nilai/tugas milik ${studentName}? Data ini akan dihapus permanen.`)) {
                try {
                    await deleteDoc(doc(db, "submissions", submissionId));
                    showMessage("Nilai berhasil direset/dihapus.", "success");
                } catch(e) {
                    console.error("Gagal hapus:", e);
                    if (e.code === 'permission-denied') {
                        showMessage("Gagal: Izin ditolak. Cek Rules Firebase (allow delete).", "error");
                    } else {
                        showMessage("Gagal mereset data: " + e.message, "error");
                    }
                }
            }
        }

        // --- DATA LISTENERS ---
        function setupListeners(uid, role) {
            onSnapshot(query(collection(db, "materials")), (snap) => {
                materialsCache.clear();
                const mats = [];
                snap.forEach(d => { const m={id:d.id, ...d.data()}; mats.push(m); materialsCache.set(d.id, m); });
                mats.sort((a,b) => {
                    const getOrder = (i) => i.order ?? (i.title.match(/(\d+)/)?.[0] ? parseInt(i.title.match(/(\d+)/)[0]) : 999);
                    return getOrder(a) - getOrder(b);
                });
                
                const list = document.getElementById('material-list');
                list.innerHTML = '';
                mats.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-3 mb-1 rounded-lg hover:bg-gray-100 font-medium transition";
                    btn.textContent = m.title;
                    btn.onclick = () => selectMaterial(m.id);
                    if(m.id === currentEditingMaterialId) btn.classList.add('bg-blue-50', 'text-blue-700');
                    list.appendChild(btn);
                });
                
                // Handle deletion case or update
                if(currentEditingMaterialId) {
                    if (materialsCache.has(currentEditingMaterialId)) {
                        document.getElementById('material-title').textContent = materialsCache.get(currentEditingMaterialId).title;
                    } else {
                        // Material deleted, reset view
                        currentEditingMaterialId = null;
                        document.getElementById('material-title').textContent = 'Pilih materi dari daftar di sebelah kiri';
                        document.getElementById('material-tabs').classList.add('hidden');
                        document.getElementById('edit-title-btn').classList.add('hidden');
                        document.getElementById('delete-material-btn').classList.add('hidden');
                        document.getElementById('worksheet-content').classList.remove('hidden');
                        document.getElementById('worksheet-details').classList.add('hidden');
                        document.getElementById('edit-content').classList.add('hidden');
                        document.getElementById('recap-content').classList.add('hidden');
                        document.getElementById('worksheet-empty').classList.remove('hidden');
                        document.querySelector('#worksheet-empty p').textContent = "Materi yang dipilih telah dihapus.";
                    }
                }
            }, err => console.warn("Materials permission:", err.code));

            let qSub = role==='dosen' ? query(collection(db, "submissions")) : query(collection(db, "submissions"), where("userId", "==", uid));
            onSnapshot(qSub, (snap) => {
                submissionsCache.clear();
                snap.forEach(d => submissionsCache.set(d.id, { id: d.id, ...d.data() }));
                if(currentEditingMaterialId) {
                    const activeTab = document.querySelector('.tab-button.border-blue-500')?.dataset.tab;
                    if(activeTab === 'worksheet') renderWorksheet(currentEditingMaterialId);
                    else if(activeTab === 'recap') renderRecap(currentEditingMaterialId);
                    else if(activeTab === 'student-recap') renderStudentRecap();
                }
            }, err => console.warn("Subs permission:", err.code));

            onSnapshot(query(collection(db, "users")), (snap) => {
                usersCache.clear();
                snap.forEach(d => usersCache.set(d.id, d.data()));
                if(currentEditingMaterialId) renderRecap(currentEditingMaterialId);
            });

            if(role === 'dosen') checkInitData();
        }

        async function checkInitData() {
            const snap = await getDocs(query(collection(db, "materials")));
            if(snap.empty) {
                const titles = ["Pertemuan 1: Intro", "Pertemuan 2: Telephoning", "Pertemuan 3: Emails", "Pertemuan 4: Meetings", "Pertemuan 5: Presentations", "Pertemuan 6: UTS", "Pertemuan 7: Negotiations", "Pertemuan 8: Vocab Finance", "Pertemuan 9: Vocab Marketing", "Pertemuan 10: Socializing", "Pertemuan 11: Reports", "Pertemuan 12: UAS"];
                titles.forEach((t,i) => addDoc(collection(db, "materials"), {title: t, order: i+1}));
            }
        }

        // --- UI FUNCTIONS ---
        function selectMaterial(id) {
            currentEditingMaterialId = id;
            const mat = materialsCache.get(id);
            document.getElementById('material-title').textContent = mat.title;
            document.getElementById('material-tabs').classList.remove('hidden');
            if(userRole==='dosen') {
                document.getElementById('edit-title-btn').classList.remove('hidden');
                document.getElementById('delete-material-btn').classList.remove('hidden');
            }
            
            const btns = document.getElementById('material-list').children;
            for(let b of btns) {
                b.classList.remove('bg-blue-50', 'text-blue-700');
                // Simple matching based on text content since we rebuild list
                if (b.textContent === mat.title) b.classList.add('bg-blue-50', 'text-blue-700'); 
            }
            showTab('worksheet');
        }

        function showTab(tab) {
            ['worksheet', 'edit', 'recap', 'student-recap'].forEach(t => {
                const el = document.getElementById(t==='worksheet'?'worksheet-details':(t+'-content'));
                if(el) el.classList.add('hidden');
            });
            document.getElementById('worksheet-content').classList.remove('hidden');
            document.getElementById('worksheet-loading').classList.add('hidden');
            document.getElementById('worksheet-empty').classList.add('hidden');

            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-600');
                if(b.dataset.tab === tab) b.classList.add('border-blue-500', 'text-blue-600');
            });

            if(tab==='worksheet') renderWorksheet(currentEditingMaterialId);
            else if(tab==='edit') renderEdit(currentEditingMaterialId);
            else if(tab==='recap') renderRecap(currentEditingMaterialId);
            else if(tab==='student-recap') renderStudentRecap();
            
            if(window.lucide) lucide.createIcons();
        }

        function renderWorksheet(id) {
            const mat = materialsCache.get(id);
            const sub = submissionsCache.get(`${id}_${currentUserId}`);
            const el = document.getElementById('worksheet-details');
            el.classList.remove('hidden');
            
            document.getElementById('worksheet-form-container').innerHTML = '';
            document.getElementById('worksheet-form-container').classList.add('hidden');
            document.getElementById('worksheet-score-card').classList.add('hidden');
            document.getElementById('submit-worksheet-btn').classList.add('hidden');
            document.getElementById('task-submission-container').classList.add('hidden');

            const ebookDiv = document.getElementById('ebook-link-container');
            if(mat.ebookUrl) { ebookDiv.classList.remove('hidden'); document.getElementById('ebook-link').href = mat.ebookUrl; }
            else ebookDiv.classList.add('hidden');

            const readDiv = document.getElementById('worksheet-reading-content');
            if(mat.readingContentHTML) { readDiv.innerHTML = mat.readingContentHTML; readDiv.classList.remove('hidden'); }
            else readDiv.classList.add('hidden');

            let quiz = null;
            try { quiz = JSON.parse(mat.quizJsonString); } catch(e){}
            const hasQuiz = quiz && quiz.questions && quiz.questions.length > 0;
            const hasTask = mat.enableTaskSubmission;

            if(!hasQuiz && !hasTask && !mat.ebookUrl && !mat.readingContentHTML) {
                el.classList.add('hidden');
                document.getElementById('worksheet-empty').classList.remove('hidden');
                document.querySelector('#worksheet-empty p').textContent = "Belum ada konten.";
                return;
            }

            if(sub && userRole==='mahasiswa') {
                const card = document.getElementById('worksheet-score-card');
                card.classList.remove('hidden');
                document.getElementById('score-display-container').style.display = hasQuiz ? 'block' : 'none';
                document.getElementById('score-card-text').textContent = sub.score || 0;
                
                const taskMsg = document.getElementById('task-submitted-msg');
                if(sub.taskUrl) { taskMsg.innerHTML = `<a href="${sub.taskUrl}" target="_blank" class="underline">Lihat Tugas</a>`; taskMsg.classList.remove('hidden'); }
                else taskMsg.classList.add('hidden');
                return;
            }

            if(hasQuiz) {
                const form = document.getElementById('worksheet-form-container');
                form.classList.remove('hidden');
                quiz.questions.forEach((q, idx) => {
                    const div = document.createElement('div');
                    div.className = "p-4 border rounded mb-4 bg-white";
                    let h = `<label class="block font-semibold mb-2">${idx+1}. ${q.question || q.question_text}</label>`;
                    const type = q.type || q.question_type;
                    
                    if(type==='multiple_choice') {
                        q.options.forEach((o, i) => {
                            const val = o.id || i;
                            const txt = o.text || o;
                            h += `<label class="block"><input type="radio" name="q${idx}" value="${val}"> ${txt}</label>`;
                        });
                    } else if (type==='true_false') {
                        h += `<label class="block"><input type="radio" name="q${idx}" value="true"> True</label>`;
                        h += `<label class="block"><input type="radio" name="q${idx}" value="false"> False</label>`;
                    } else {
                        h += `<input type="text" name="q${idx}" class="border w-full p-2 rounded">`;
                    }
                    div.innerHTML = h;
                    form.appendChild(div);
                });
            }

            if(hasTask) document.getElementById('task-submission-container').classList.remove('hidden');
            if(userRole==='mahasiswa' && (hasQuiz || hasTask)) document.getElementById('submit-worksheet-btn').classList.remove('hidden');
        }

        async function handleSubmit() {
            const mat = materialsCache.get(currentEditingMaterialId);
            let quiz = null;
            try { quiz = JSON.parse(mat.quizJsonString); } catch(e){}
            
            const answers = {};
            let score = 0;
            
            if(quiz && quiz.questions) {
                let correct = 0;
                quiz.questions.forEach((q, idx) => {
                    let val = null;
                    const type = q.type || q.question_type;
                    if(type==='fill_in_the_blank') {
                        const el = document.querySelector(`input[name="q${idx}"]`);
                        if(el) val = el.value.trim().toLowerCase();
                    } else {
                        const el = document.querySelector(`input[name="q${idx}"]:checked`);
                        if(el) val = el.value;
                    }
                    answers[`q${idx}`] = val;

                    let key = q.correct_answer;
                    if(key === undefined && q.answer) key = q.answer; 
                    if(typeof key === 'boolean') key = String(key);
                    if(type === 'multiple_choice' && typeof key === 'number') key = String(key);
                    
                    if(val && String(val).toLowerCase() === String(key).toLowerCase()) correct++;
                });
                score = Math.round((correct / quiz.questions.length) * 100);
            }

            const taskUrl = document.getElementById('task-url-input').value;
            const data = { userId: currentUserId, materialId: currentEditingMaterialId, score, answers, submittedAt: new Date() };
            if(mat.enableTaskSubmission && taskUrl) data.taskUrl = taskUrl;

            await setDoc(doc(db, "submissions", `${currentEditingMaterialId}_${currentUserId}`), data, {merge:true});
            showMessage("Tersimpan!", "success");
        }

        function renderEdit(id) {
            const m = materialsCache.get(id);
            document.getElementById('edit-content').classList.remove('hidden');
            document.getElementById('ebook-url-input').value = m.ebookUrl || '';
            document.getElementById('enable-task-submission').checked = !!m.enableTaskSubmission;
            document.getElementById('worksheet-json-input').value = m.quizJsonString || '';
            if(window.tinymce && tinymce.get('reading-content-editor')) {
                tinymce.get('reading-content-editor').setContent(m.readingContentHTML || '');
            } else {
                document.getElementById('reading-content-editor').value = m.readingContentHTML || '';
            }
        }

        async function handleSave() {
            const id = currentEditingMaterialId;
            const data = {
                ebookUrl: document.getElementById('ebook-url-input').value,
                enableTaskSubmission: document.getElementById('enable-task-submission').checked,
                quizJsonString: document.getElementById('worksheet-json-input').value,
                readingContentHTML: tinymce.get('reading-content-editor')?.getContent() || ''
            };
            try { JSON.parse(data.quizJsonString || '{}'); } catch(e) { return showMessage("JSON Error", "error"); }
            await updateDoc(doc(db, "materials", id), data);
            showMessage("Disimpan.");
        }

        async function handleEditTitle() {
            const t = prompt("Judul Baru:");
            if(t) await updateDoc(doc(db, "materials", currentEditingMaterialId), {title: t});
        }

        // --- NEW DELETE FUNCTION ---
        async function handleDeleteMaterial() {
            if(userRole !== 'dosen' || !currentEditingMaterialId) return;
            const m = materialsCache.get(currentEditingMaterialId);
            if(confirm(`Yakin ingin MENGHAPUS materi "${m.title}"?`)) {
                try {
                    await deleteDoc(doc(db, "materials", currentEditingMaterialId));
                    showMessage("Materi dihapus.");
                    // selectMaterial logic handles the rest when cache updates
                } catch (e) {
                    console.error(e);
                    showMessage("Gagal hapus (Cek Rules).", "error");
                }
            }
        }

        function renderRecap(id) {
            document.getElementById('recap-content').classList.remove('hidden');
            const tbody = document.getElementById('recap-table-body');
            tbody.innerHTML = '';
            
            const subs = [];
            submissionsCache.forEach(s => { if(s.materialId === id) subs.push(s); });
            
            if(subs.length === 0) { document.getElementById('recap-no-data').classList.remove('hidden'); document.getElementById('recap-table').classList.add('hidden'); return; }
            
            document.getElementById('recap-no-data').classList.add('hidden');
            document.getElementById('recap-table').classList.remove('hidden');
            document.getElementById('recap-material-title').textContent = materialsCache.get(id).title;

            subs.forEach(s => {
                const u = usersCache.get(s.userId) || {displayName: 'Unknown', email: 'Unknown'};
                const tr = document.createElement('tr');
                const tdAction = document.createElement('td');
                tdAction.className = "px-6 py-4";
                const btn = document.createElement('button');
                btn.className = "text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded transition";
                btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                btn.onclick = () => window.handleResetSubmission(s.id, u.displayName);
                tdAction.appendChild(btn);

                tr.innerHTML = `<td class="px-6 py-4">${u.displayName}</td><td class="px-6 py-4">${u.email}</td><td class="px-6 py-4 font-bold text-blue-600">${s.score}</td><td class="px-6 py-4">${s.taskUrl ? `<a href="${s.taskUrl}" target="_blank" class="text-blue-600 underline">Link</a>` : '-'}</td><td class="px-6 py-4 text-gray-500">${s.submittedAt ? new Date(s.submittedAt.seconds*1000).toLocaleDateString() : '-'}</td>`;
                tr.appendChild(tdAction);
                tbody.appendChild(tr);
            });
            if(window.lucide) lucide.createIcons();
        }

        function renderStudentRecap() {
            document.getElementById('student-recap-content').classList.remove('hidden');
            const tbody = document.getElementById('student-recap-table-body');
            tbody.innerHTML = '';
            
            const subs = Array.from(submissionsCache.values());
            if(subs.length===0) { document.getElementById('student-recap-no-data').classList.remove('hidden'); document.getElementById('student-recap-table').classList.add('hidden'); return; }
            
            document.getElementById('student-recap-no-data').classList.add('hidden');
            document.getElementById('student-recap-table').classList.remove('hidden');
            
            subs.sort((a,b) => {
                const mA = materialsCache.get(a.materialId); const mB = materialsCache.get(b.materialId);
                return (mA?.order||99) - (mB?.order||99);
            });

            subs.forEach(s => {
                const m = materialsCache.get(s.materialId);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-6 py-4">${m?m.title:'Deleted'}</td><td class="px-6 py-4 font-bold text-blue-600">${s.score}</td><td class="px-6 py-4 text-gray-500">${s.submittedAt ? new Date(s.submittedAt.seconds*1000).toLocaleDateString() : '-'}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            createFireflyAnimations();
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            addMaterialBtn.addEventListener('click', async () => {
                const t = prompt("Judul:"); if(t) await addDoc(collection(db,"materials"), {title:t, order: materialsCache.size+1});
            });
            editTitleBtn.addEventListener('click', handleEditTitle);
            deleteMaterialBtn.addEventListener('click', handleDeleteMaterial);
            saveWorksheetBtn.addEventListener('click', handleSave);
            submitWorksheetBtn.addEventListener('click', handleSubmit);
            
            tabButtons.forEach(b => {
                b.addEventListener('click', () => showTab(b.dataset.tab));
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUserId = user.uid;
                userRole = await saveUserData(user);
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('user-role-display').querySelector('span').textContent = userRole;
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                
                if(userRole === 'dosen') {
                    document.getElementById('add-material-container').classList.remove('hidden');
                    document.querySelectorAll('.tab-button-dosen').forEach(e=>e.classList.remove('hidden'));
                    tinymce.init({ selector: '#reading-content-editor', height: 400, menubar: false, plugins: 'lists link image code', toolbar: 'undo redo | bold italic | bullist numlist | link | code' });
                } else {
                    document.querySelectorAll('.tab-button-mahasiswa').forEach(e=>e.classList.remove('hidden'));
                }
                
                setupListeners(user.uid, userRole);
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
